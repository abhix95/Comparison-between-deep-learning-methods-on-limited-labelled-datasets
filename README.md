---
layout: default
---

In this post I will explain my setup for studying effects( !!!spoiler!!! possible benefits) of using pre-initialized weights in a Convolutional Neural Network (CNN). 

I have tried to study the difference by comparing results of a model that started training from random weights with results of the same model that started training from weights given by the convolutional autoencoder. I will be using MNIST to study the difference.

For this post, my library of choice is Keras (1.?.?) with Theano serving in its backend. I have used my laptop whuch is equipped with a Nvidia Quadro M1000M for this project. Running the same without a GPU will take a noticably long time although being MNIST it won't be too much.

So let's begin.

#### Before the code

Let us understand the basics of Convolutional Neural Networks(CNN) and Convolutional Auto-Encoders(CAE).

##### 1> CNN
> To understand CNN use this [post](ashirgao.github.io/CNN-basics/) of mine as reference.

##### 2> CAE
> As for CAEs

>![Convolutional Autoencoder][CAE]

[CAE]: CAEandCNN_files/CAE.jpg

> CAE are made of 2 halves:
> 1> The encoder
> 2> The decoder

> The encoder is made of convolution and downsampling layers while the decoder is made of deconvolution(convolution) and upsampling layers. The encoder is resposible to encode the image using spatial features into an intermediate representation which holds information of the whole image. The decoder accepts this intermediate representation and tries to regenerate the orignal image. Loss for a CAE is the euclidean distance between respective pixels of the input image and decoded image. As the CAE is trained, we can say that the intermediate representation is an embedding of that image. We can also say that the convolutions in the encoder part of the CAE have become increasingly tuned to extract features from images that were used for the training. 
>This is exactly what we need. If we initialize the CNN with the weights of this encoder, from intution we can infer that the CNN will start looking at more relevant features in image that the convolutions with random initializations. Thus,
>
>>if we have lots of unlabelled data and limited labelled data, we can use the unlabelled data to train a CAE. Then, we can use the weights from the encoder to initialize weights of CNN. Then we train the CNN on the labelled data.
>
>In this post we will compare the model mentioned right above with a randomly initialized CNN trained only with the labelled data available.

![Approaches][Apps]

[Apps]: CAEandCNN_files/approaches.jpg

#### Import libraries

For (model structure) visualization purpose, I have used [model_to_dot](https://keras.io/visualization/). This requires ```pydot``` and ```graphviz``` which are not installed automatically with keras. Also you might need to install ```h5py``` which is needed to save model weights. 

```shell
$ pip install h5py pydot graphviz
```
Now that we have the environment setup, let's start.

```python
from keras.layers import Input, Dense, Conv2D, MaxPooling2D, UpSampling2D, Activation, Flatten, Dropout
from keras.models import Sequential
from keras import backend as K
from keras.models import Model
from keras.utils import np_utils

from keras.datasets import mnist
import numpy as np

import matplotlib.pyplot as plt
from IPython.display import SVG
from keras.utils.visualize_util import model_to_dot

%matplotlib inline
```

    Using Theano backend.
    


#### Load data

If only loading data was so simple for project every time.....
.
.
Don't worry you'll used to it after a while.

I have appended the training and test set to get ```x``` and ```y``` ie. all of my labelled data.

```python
(x_train, y_train), (x_test, y_test) = mnist.load_data()
x_train = x_train.astype('float32') / 255.
x_test = x_test.astype('float32') / 255.

x = np.append(x_train,x_test,axis=0)
y = np.append(y_train,y_test,axis=0)
print"x shape : ", x.shape
print"y shape : ", y.shape

count = 0
```

    x shape :  (70000, 28, 28)
    y shape :  (70000,)


#### Define variables

I plan to vary the amount of data I appropriate for my CNN and CAE.I have added this block for easy manipulation of these variables so as to try and find the ratio of labelled to unlabelled data when benefits of using this method are maximum.

```python
epochs_for_cae = 40
epochs_for_cnn = 20

training_samples_for_cae   = 25000
validation_samples_for_cae = 5000

training_samples_for_cnn   = 25000
testing_samples_for_cnn = 10000
validation_samples_for_cnn = 5000

sum = training_samples_for_cae+training_samples_for_cnn+validation_samples_for_cae+validation_samples_for_cnn+testing_samples_for_cnn

if(sum>70000):
    print("***********\nOnly 70,000 data points, re-define variables such that their sum is less than 70,000.\n***********")
```

#### Autoencoder data

As MNIST data is small, I can easily fit the whole data in memory(RAM). In case of larger datasets use generators to load batch online( CPU loads and preprocesses a batch at a time and GPU trains on it). 
```python
cae_x_train = np.reshape(x[count:count+training_samples_for_cae], (training_samples_for_cae, 1, 28, 28))
count = count + training_samples_for_cae

cae_x_validation = np.reshape(x[count:count+validation_samples_for_cae], (validation_samples_for_cae, 1, 28, 28))
count = count + validation_samples_for_cae

print "cae_x_train shape : ", cae_x_train.shape
print "cae_x_validation shape : ", cae_x_validation.shape
```

    cae_x_train shape :  (25000, 1, 28, 28)
    cae_x_validation shape :  (5000, 1, 28, 28)


#### CAE model

The CNN uses weights from the encoder part of the CAE. Thus the model architecture for them must be same. In keras, it is necessary for the layers of CAE encoder and CNN model to have the same name. 

```python
print "Output shapes after subsequent layers : "

cae = Sequential()

cae.add(Conv2D(8, 3, 3, border_mode='same',  input_shape=(1, 28, 28),name='conv1' ))
cae.add(Activation('relu'))
cae.add(MaxPooling2D(pool_size=(2, 2), border_mode='same'))
print(cae.layers[-1].output_shape)

cae.add(Conv2D(16, 3, 3, border_mode='same', name='conv2'))
cae.add(Activation('relu'))
cae.add(MaxPooling2D(pool_size=(2, 2), border_mode='same'))
print(cae.layers[-1].output_shape)

cae.add(Conv2D(8, 3, 3 , border_mode='same', name='conv3'))
cae.add(Activation('relu'))
cae.add(MaxPooling2D(pool_size=(2, 2), border_mode='same', name='encoded'))
print(cae.layers[-1].output_shape)

# at this point the representation is (4, 4, 8) i.e. 128-dimensional

cae.add(Conv2D(8, 3, 3, activation='relu', border_mode='same'))
cae.add(UpSampling2D(size=(2, 2)))
print(cae.layers[-1].output_shape)

cae.add(Conv2D(16, 3, 3, activation='relu', border_mode='same'))
cae.add(UpSampling2D(size=(2, 2)))
print(cae.layers[-1].output_shape)

cae.add(Conv2D(8, 3, 3, activation='relu'))
cae.add(UpSampling2D(size=(2, 2)))
print(cae.layers[-1].output_shape)

cae.add(Conv2D(1, 3, 3, activation='sigmoid', border_mode='same', name='decoded'))
print(cae.layers[-1].output_shape)

cae.compile(optimizer='adadelta', loss='binary_crossentropy')

```

    Output shapes after subsequent layers : 
    (None, 8, 14, 14)
    (None, 16, 7, 7)
    (None, 8, 4, 4)
    (None, 8, 8, 8)
    (None, 16, 16, 16)
    (None, 8, 28, 28)
    (None, 1, 28, 28)


#### Model summary

As CNNs share weights over many pixels, the total number of parameters is less than a deep neural network made of onle ```Dense``` layers. This makes it easier to train CNNs.

```python
cae.summary()
```

    ____________________________________________________________________________________________________
    Layer (type)                     Output Shape          Param #     Connected to                     
    ====================================================================================================
    conv1 (Convolution2D)            (None, 8, 28, 28)     80          convolution2d_input_1[0][0]      
    ____________________________________________________________________________________________________
    activation_1 (Activation)        (None, 8, 28, 28)     0           conv1[0][0]                      
    ____________________________________________________________________________________________________
    maxpooling2d_1 (MaxPooling2D)    (None, 8, 14, 14)     0           activation_1[0][0]               
    ____________________________________________________________________________________________________
    conv2 (Convolution2D)            (None, 16, 14, 14)    1168        maxpooling2d_1[0][0]             
    ____________________________________________________________________________________________________
    activation_2 (Activation)        (None, 16, 14, 14)    0           conv2[0][0]                      
    ____________________________________________________________________________________________________
    maxpooling2d_2 (MaxPooling2D)    (None, 16, 7, 7)      0           activation_2[0][0]               
    ____________________________________________________________________________________________________
    conv3 (Convolution2D)            (None, 8, 7, 7)       1160        maxpooling2d_2[0][0]             
    ____________________________________________________________________________________________________
    activation_3 (Activation)        (None, 8, 7, 7)       0           conv3[0][0]                      
    ____________________________________________________________________________________________________
    encoded (MaxPooling2D)           (None, 8, 4, 4)       0           activation_3[0][0]               
    ____________________________________________________________________________________________________
    convolution2d_1 (Convolution2D)  (None, 8, 4, 4)       584         encoded[0][0]                    
    ____________________________________________________________________________________________________
    upsampling2d_1 (UpSampling2D)    (None, 8, 8, 8)       0           convolution2d_1[0][0]            
    ____________________________________________________________________________________________________
    convolution2d_2 (Convolution2D)  (None, 16, 8, 8)      1168        upsampling2d_1[0][0]             
    ____________________________________________________________________________________________________
    upsampling2d_2 (UpSampling2D)    (None, 16, 16, 16)    0           convolution2d_2[0][0]            
    ____________________________________________________________________________________________________
    convolution2d_3 (Convolution2D)  (None, 8, 14, 14)     1160        upsampling2d_2[0][0]             
    ____________________________________________________________________________________________________
    upsampling2d_3 (UpSampling2D)    (None, 8, 28, 28)     0           convolution2d_3[0][0]            
    ____________________________________________________________________________________________________
    decoded (Convolution2D)          (None, 1, 28, 28)     73          upsampling2d_3[0][0]             
    ====================================================================================================
    Total params: 5,393
    Trainable params: 5,393
    Non-trainable params: 0
    ____________________________________________________________________________________________________


#### Diagram

Visual representation of model. Using tensorflow as the backend opens access to TensorBoard which has much fancy visuals.

```python
SVG(model_to_dot(cae).create(prog='dot', format='svg'))
```




![svg](CAEandCNN_files/CAEandCNN_14_0.svg)



#### Train

Output of CAE (decoder) is expected to be similar to the input of CAE (encoder). Thus, there is no metric to calculate accuracy here. Loss is the eucleadian distance between the output image of model with the input image that it was passeed. Thus we try to reduce this loss.

```python
cae.fit(cae_x_train, cae_x_train,
	                nb_epoch=epochs_for_cae,
	                batch_size=128,
                    verbose=1,
	                shuffle=True,
	                validation_data=(cae_x_validation, cae_x_validation))
```

    Train on 25000 samples, validate on 5000 samples
    Epoch 1/40
    25000/25000 [==============================] - 8s - loss: 0.2912 - val_loss: 0.2055
    Epoch 2/40
    25000/25000 [==============================] - 7s - loss: 0.1903 - val_loss: 0.1855
    Epoch 3/40
    25000/25000 [==============================] - 7s - loss: 0.1719 - val_loss: 0.1662
    Epoch 4/40
    25000/25000 [==============================] - 7s - loss: 0.1597 - val_loss: 0.1529
    Epoch 5/40
    25000/25000 [==============================] - 7s - loss: 0.1516 - val_loss: 0.1467
    Epoch 6/40
    25000/25000 [==============================] - 7s - loss: 0.1461 - val_loss: 0.1434
    Epoch 7/40
    25000/25000 [==============================] - 7s - loss: 0.1415 - val_loss: 0.1447
    Epoch 8/40
    25000/25000 [==============================] - 7s - loss: 0.1379 - val_loss: 0.1353
    Epoch 9/40
    25000/25000 [==============================] - 7s - loss: 0.1349 - val_loss: 0.1339
    Epoch 10/40
    25000/25000 [==============================] - 7s - loss: 0.1192 - val_loss: 0.1181
    Epoch 22/40
    25000/25000 [==============================] - 7s - loss: 0.1187 - val_loss: 0.1209 - ETA: 2s - loss: 0.1188 - ETA: 0s - loss: 0.1186
    Epoch 23/40
    25000/25000 [==============================] - 7s - loss: 0.1178 - val_loss: 0.1172
    Epoch 24/40
    25000/25000 [==============================] - 7s - loss: 0.1173 - val_loss: 0.1175
    Epoch 25/40
    25000/25000 [==============================] - 7s - loss: 0.1168 - val_loss: 0.1164
    Epoch 26/40
    25000/25000 [==============================] - 7s - loss: 0.1164 - val_loss: 0.1147
    Epoch 27/40
    25000/25000 [==============================] - 7s - loss: 0.1153 - val_loss: 0.1161
    Epoch 28/40
    25000/25000 [==============================] - 7s - loss: 0.1151 - val_loss: 0.1138
    Epoch 29/40
    25000/25000 [==============================] - 7s - loss: 0.1147 - val_loss: 0.1146
    Epoch 30/40
    25000/25000 [==============================] - 7s - loss: 0.1141 - val_loss: 0.1139
    Epoch 31/40
    25000/25000 [==============================] - 7s - loss: 0.1135 - val_loss: 0.1127
    Epoch 32/40
    25000/25000 [==============================] - 7s - loss: 0.1134 - val_loss: 0.1181
    Epoch 33/40
    25000/25000 [==============================] - 8s - loss: 0.1126 - val_loss: 0.1131
    Epoch 34/40
    25000/25000 [==============================] - 8s - loss: 0.1125 - val_loss: 0.1107
    Epoch 35/40
    25000/25000 [==============================] - 8s - loss: 0.1121 - val_loss: 0.1131
    Epoch 36/40
    25000/25000 [==============================] - 7s - loss: 0.1114 - val_loss: 0.1117
    Epoch 37/40
    25000/25000 [==============================] - 7s - loss: 0.1110 - val_loss: 0.1123
    Epoch 38/40
    25000/25000 [==============================] - 7s - loss: 0.1107 - val_loss: 0.1106
    Epoch 39/40
    25000/25000 [==============================] - 8s - loss: 0.1105 - val_loss: 0.1097
    Epoch 40/40
    25000/25000 [==============================] - 7s - loss: 0.1105 - val_loss: 0.1092





    <keras.callbacks.History at 0x7f4ff0746910>



#### Save model

We need ```h5py``` module for this cell. It is a good practice to include epoch number, training set size or other distinguishing factors in the name of the file containing weights of the model. 

```python
cae_name = 'mnist_cae_'+str(epochs_for_cae)+'e_'+str(training_samples_for_cae)+'i.h5'
cae.save(cae_name)
```

#### Check results and encoded representation

Visualize! Visualize! 

![jpg](CAEandCNN_files/bret.jpg)

(remember Bret Stiles?)

```python
test = cae_x_validation
test = np.reshape(test,(validation_samples_for_cae,1,28,28))
decoded_imgs = cae.predict(test)
encoder = Model(input=cae.input, output=cae.get_layer('encoded').output)
encoded_imgs = encoder.predict(test)

print "Results (orignal vs reconstructed image): "
n = 10
plt.figure(figsize=(20, 4))
for i in range(n):
    # display original
    ax = plt.subplot(2, n, i+1)
    plt.imshow(test[i].reshape(28, 28))
    plt.gray()
    ax.get_xaxis().set_visible(False)
    ax.get_yaxis().set_visible(False)

    # display reconstruction
    ax = plt.subplot(2, n, i + 1 + n)
    plt.imshow(decoded_imgs[i].reshape(28, 28))
    plt.gray()
    ax.get_xaxis().set_visible(False)
    ax.get_yaxis().set_visible(False)
plt.show()

print "Encoded representation : "
n = 10
plt.figure(figsize=(20, 8))
for i in range(n):
    ax = plt.subplot(1, n, i+1)
    plt.imshow(encoded_imgs[i].reshape(4, 4 * 8).T)
    plt.gray()
    ax.get_xaxis().set_visible(False)
    ax.get_yaxis().set_visible(False)
plt.show()
```

    Results (orignal vs reconstructed image): 



![png](CAEandCNN_files/CAEandCNN_20_1.png)


    Encoded representation : 



![png](CAEandCNN_files/CAEandCNN_20_3.png)


#### CNN data

Preparing data for CNN training. Number of samples for CNN training is decided beforehand.

```python
cnn_x_train = np.reshape(x[count:count+training_samples_for_cnn], (training_samples_for_cnn, 1, 28, 28))
cnn_y_train = np_utils.to_categorical(y[count:count+training_samples_for_cnn], nb_classes=10)
count = count + training_samples_for_cnn

cnn_x_test = np.reshape(x[count:count+testing_samples_for_cnn], (testing_samples_for_cnn, 1, 28, 28))
cnn_y_test = np_utils.to_categorical(y[count:count+testing_samples_for_cnn], nb_classes=10)
count = count + testing_samples_for_cnn

cnn_x_validation = np.reshape(x[count:count+validation_samples_for_cnn], (validation_samples_for_cnn, 1, 28, 28))
cnn_y_validation = np_utils.to_categorical(y[count:count+validation_samples_for_cnn], nb_classes=10)
count = count + validation_samples_for_cnn

print "cnn_x_train shape : ", cnn_x_train.shape
print "cnn_x_test shape : ", cnn_x_test.shape
print "cnn_x_validation shape : ", cnn_x_validation.shape

print "cnn_y_train shape : ", cnn_y_train.shape
print "cnn_y_test shape : ", cnn_y_test.shape
print "cnn_y_validation shape : ", cnn_y_validation.shape
```

    cnn_x_train shape :  (25000, 1, 28, 28)
    cnn_x_test shape :  (10000, 1, 28, 28)
    cnn_x_validation shape :  (5000, 1, 28, 28)
    cnn_y_train shape :  (25000, 10)
    cnn_y_test shape :  (10000, 10)
    cnn_y_validation shape :  (5000, 10)


#### CNN model

Define model for CNN. It must be same as the encoder of CAE. In keras, the names of individual layers must also match.

```python
model = Sequential()

model.add(Conv2D(8, 3, 3, activation='relu', border_mode='same',  input_shape=(1, 28, 28), name='conv1' ))
model.add(MaxPooling2D(pool_size=(2, 2), border_mode='same'))

model.add(Conv2D(16, 3, 3, activation='relu', border_mode='same', name='conv2'))
model.add(MaxPooling2D(pool_size=(2, 2), border_mode='same'))

model.add(Conv2D(8, 3, 3, activation='relu', border_mode='same', name='conv3'))
model.add(MaxPooling2D(pool_size=(2, 2), border_mode='same', name='encoded'))

model.add(Flatten())
model.add(Dense(16))

model.add(Activation('relu'))
model.add(Dropout(0.5))

model.add(Dense(10))
model.add(Activation('softmax'))

```

#### Model summary

Thank-you keras for this.

```python
model.summary()
```

    ____________________________________________________________________________________________________
    Layer (type)                     Output Shape          Param #     Connected to                     
    ====================================================================================================
    conv1 (Convolution2D)            (None, 8, 28, 28)     80          convolution2d_input_6[0][0]      
    ____________________________________________________________________________________________________
    maxpooling2d_11 (MaxPooling2D)   (None, 8, 14, 14)     0           conv1[0][0]                      
    ____________________________________________________________________________________________________
    conv2 (Convolution2D)            (None, 16, 14, 14)    1168        maxpooling2d_11[0][0]            
    ____________________________________________________________________________________________________
    maxpooling2d_12 (MaxPooling2D)   (None, 16, 7, 7)      0           conv2[0][0]                      
    ____________________________________________________________________________________________________
    conv3 (Convolution2D)            (None, 8, 7, 7)       1160        maxpooling2d_12[0][0]            
    ____________________________________________________________________________________________________
    encoded (MaxPooling2D)           (None, 8, 4, 4)       0           conv3[0][0]                      
    ____________________________________________________________________________________________________
    flatten_3 (Flatten)              (None, 128)           0           encoded[0][0]                    
    ____________________________________________________________________________________________________
    dense_4 (Dense)                  (None, 16)            2064        flatten_3[0][0]                  
    ____________________________________________________________________________________________________
    activation_10 (Activation)       (None, 16)            0           dense_4[0][0]                    
    ____________________________________________________________________________________________________
    dropout_2 (Dropout)              (None, 16)            0           activation_10[0][0]              
    ____________________________________________________________________________________________________
    dense_5 (Dense)                  (None, 10)            170         dropout_2[0][0]                  
    ____________________________________________________________________________________________________
    activation_11 (Activation)       (None, 10)            0           dense_5[0][0]                    
    ====================================================================================================
    Total params: 4,642
    Trainable params: 4,642
    Non-trainable params: 0
    ____________________________________________________________________________________________________


#### Diagram

![jpg](CAEandCNN_files/bret.jpg)

(Red John?  (^^) )

```python
SVG(model_to_dot(model).create(prog='dot', format='svg'))
```




![svg](CAEandCNN_files/CAEandCNN_28_0.svg)



#### APPROACH 1 :  Intialiazed CNN 


Finally! Now let us try approach 1 ie. CNN initialized using CAE weights.

```python
model2 = model
model2.load_weights(cae_name, by_name=True)
model2.compile(optimizer='adadelta', loss='categorical_crossentropy',metrics=['accuracy'])
model2.fit(cnn_x_train, cnn_y_train,
                nb_epoch=epochs_for_cnn,
                batch_size=128,
                shuffle=True,
                verbose=1,
                validation_data=(cnn_x_validation, cnn_y_validation))
```

    Train on 25000 samples, validate on 5000 samples
	Epoch 1/20
	25000/25000 [==============================] - 13s - loss: 1.8523 - acc: 0.6000 - val_loss: 0.1355 - val_acc: 0.9746 - ETA: 13s - loss: 13.7110 - acc: 0.1208 - ETA: 8s - loss: 3.5260 - acc: 0.4371
	Epoch 2/20
	25000/25000 [==============================] - 12s - loss: 0.7200 - acc: 0.7369 - val_loss: 0.1029 - val_acc: 0.9794 - ETA: 12s - loss: 0.7538 - acc: 0.7346
	Epoch 3/20
	25000/25000 [==============================] - 12s - loss: 0.6510 - acc: 0.7622 - val_loss: 0.0892 - val_acc: 0.9816
	Epoch 4/20
	25000/25000 [==============================] - 12s - loss: 0.6304 - acc: 0.7743 - val_loss: 0.0841 - val_acc: 0.9798
	Epoch 5/20
	25000/25000 [==============================] - 12s - loss: 0.6055 - acc: 0.7803 - val_loss: 0.0834 - val_acc: 0.9824
	Epoch 6/20
	25000/25000 [==============================] - 12s - loss: 0.5973 - acc: 0.7828 - val_loss: 0.0852 - val_acc: 0.9814
	Epoch 7/20
	25000/25000 [==============================] - 12s - loss: 0.5974 - acc: 0.7811 - val_loss: 0.1044 - val_acc: 0.9794
	Epoch 8/20
	25000/25000 [==============================] - 12s - loss: 0.5812 - acc: 0.7894 - val_loss: 0.0759 - val_acc: 0.9838
	Epoch 9/20
	25000/25000 [==============================] - 12s - loss: 0.5815 - acc: 0.7904 - val_loss: 0.0650 - val_acc: 0.9850
	Epoch 10/20
	25000/25000 [==============================] - 12s - loss: 0.5782 - acc: 0.7878 - val_loss: 0.0912 - val_acc: 0.9810
	Epoch 11/20
	25000/25000 [==============================] - 12s - loss: 0.5729 - acc: 0.7890 - val_loss: 0.0765 - val_acc: 0.9822
	Epoch 12/20
	25000/25000 [==============================] - 12s - loss: 0.5720 - acc: 0.7914 - val_loss: 0.0835 - val_acc: 0.9820
	Epoch 13/20
	25000/25000 [==============================] - 12s - loss: 0.5655 - acc: 0.7977 - val_loss: 0.0617 - val_acc: 0.9850
	Epoch 14/20
	25000/25000 [==============================] - 12s - loss: 0.5710 - acc: 0.7938 - val_loss: 0.0693 - val_acc: 0.9842
	Epoch 15/20
	25000/25000 [==============================] - 12s - loss: 0.5673 - acc: 0.7926 - val_loss: 0.0843 - val_acc: 0.9806
	Epoch 16/20
	25000/25000 [==============================] - 12s - loss: 0.5614 - acc: 0.7956 - val_loss: 0.0821 - val_acc: 0.9808
	Epoch 17/20
	25000/25000 [==============================] - 12s - loss: 0.5540 - acc: 0.7994 - val_loss: 0.0777 - val_acc: 0.9824 - ETA: 11s - loss: 0.5782 - acc: 0.8258
	Epoch 18/20
	25000/25000 [==============================] - 12s - loss: 0.5525 - acc: 0.8022 - val_loss: 0.0571 - val_acc: 0.9854
	Epoch 19/20
	25000/25000 [==============================] - 12s - loss: 0.5623 - acc: 0.7990 - val_loss: 0.0749 - val_acc: 0.9808
	Epoch 20/20
	25000/25000 [==============================] - 12s - loss: 0.5507 - acc: 0.8041 - val_loss: 0.0577 - val_acc: 0.9846
	Out[17]:
	<keras.callbacks.History at 0x7fd883fc71d0>

```

#### Save model
Always as good practice to store all your models. Never know when you need which.

```python
name = 'mnist_initializedCNN_'+str(epochs_for_cnn)+'e_'+str(training_samples_for_cnn)+'i.h5'
model2.save(name)
```

#### Results of approach 1

>97.26%

Too good!! 


```python
params2 = model2.metrics_names
results2 = (model2.evaluate(cnn_x_test,cnn_y_test,verbose=0))
print params2[0]," : ", results2[0]
print params2[1]," : ", results2[1]
```

    loss  :  0.100158229173
	acc  :  0.9726





#### APPROACH 2  :  Unitialiazed CNN 

Traditional 'only CNN' approach.

```python
model1 = model
model1.compile(optimizer='adadelta', loss='categorical_crossentropy',metrics=['accuracy'])

model1.fit(cnn_x_train, cnn_y_train,
                nb_epoch=epochs_for_cnn,
                batch_size=128,
                shuffle=True,
                verbose=1,
                validation_data=(cnn_x_validation, cnn_y_validation))
```

    Train on 25000 samples, validate on 5000 samples
	Epoch 1/20
	25000/25000 [==============================] - 13s - loss: 1.2829 - acc: 0.5217 - val_loss: 0.4114 - val_acc: 0.9286 - ETA: 9s - loss: 1.5621 - acc: 0.4222 - ETA: 7s - loss: 1.4712 - acc: 0.4525
	Epoch 2/20
	25000/25000 [==============================] - 13s - loss: 1.0242 - acc: 0.6134 - val_loss: 0.2856 - val_acc: 0.9572
	Epoch 3/20
	25000/25000 [==============================] - 13s - loss: 0.9088 - acc: 0.6571 - val_loss: 0.2024 - val_acc: 0.9686
	Epoch 4/20
	25000/25000 [==============================] - 13s - loss: 0.8292 - acc: 0.6838 - val_loss: 0.1384 - val_acc: 0.9730 - ETA: 10s - loss: 0.8526 - acc: 0.6840 - ETA: 7s - loss: 0.8367 - acc: 0.6836 - ETA: 4s - loss: 0.8354 - acc: 0.6831
	Epoch 5/20
	25000/25000 [==============================] - 12s - loss: 0.7787 - acc: 0.6990 - val_loss: 0.1423 - val_acc: 0.9768
	Epoch 6/20
	25000/25000 [==============================] - 12s - loss: 0.7459 - acc: 0.7142 - val_loss: 0.1391 - val_acc: 0.9764
	Epoch 7/20
	25000/25000 [==============================] - 12s - loss: 0.7349 - acc: 0.7194 - val_loss: 0.0994 - val_acc: 0.9802 - ETA: 10s - loss: 0.7540 - acc: 0.7135
	Epoch 8/20
	25000/25000 [==============================] - 12s - loss: 0.7087 - acc: 0.7330 - val_loss: 0.0934 - val_acc: 0.9798 - ETA: 6s - loss: 0.7199 - acc: 0.7282 - ETA: 6s - loss: 0.7227 - acc: 0.7279
	Epoch 9/20
	25000/25000 [==============================] - 12s - loss: 0.6758 - acc: 0.7504 - val_loss: 0.0871 - val_acc: 0.9808 - ETA: 0s - loss: 0.6766 - acc: 0.7498
	Epoch 10/20
	25000/25000 [==============================] - 12s - loss: 0.6612 - acc: 0.7539 - val_loss: 0.0938 - val_acc: 0.9798 - ETA: 5s - loss: 0.6697 - acc: 0.7510 - ETA: 4s - loss: 0.6659 - acc: 0.7531
	Epoch 11/20
	25000/25000 [==============================] - 12s - loss: 0.6476 - acc: 0.7569 - val_loss: 0.0863 - val_acc: 0.9812
	Epoch 12/20
	25000/25000 [==============================] - 12s - loss: 0.6356 - acc: 0.7642 - val_loss: 0.0854 - val_acc: 0.9804
	Epoch 13/20
	25000/25000 [==============================] - 13s - loss: 0.6345 - acc: 0.7648 - val_loss: 0.0828 - val_acc: 0.9828 - ETA: 7s - loss: 0.6425 - acc: 0.7636
	Epoch 14/20
	25000/25000 [==============================] - 12s - loss: 0.6272 - acc: 0.7694 - val_loss: 0.0782 - val_acc: 0.9832
	Epoch 15/20
	25000/25000 [==============================] - 12s - loss: 0.6276 - acc: 0.7681 - val_loss: 0.0761 - val_acc: 0.9836 - ETA: 4s - loss: 0.6234 - acc: 0.7695
	Epoch 16/20
	25000/25000 [==============================] - 12s - loss: 0.6220 - acc: 0.7668 - val_loss: 0.0716 - val_acc: 0.9826 - ETA: 6s - loss: 0.6249 - acc: 0.7641 - ETA: 3s - loss: 0.6186 - acc: 0.7679
	Epoch 17/20
	25000/25000 [==============================] - 12s - loss: 0.6195 - acc: 0.7689 - val_loss: 0.0677 - val_acc: 0.9840 - ETA: 7s - loss: 0.6067 - acc: 0.7705 - ETA: 7s - loss: 0.6072 - acc: 0.7700
	Epoch 18/20
	25000/25000 [==============================] - 13s - loss: 0.6181 - acc: 0.7723 - val_loss: 0.0711 - val_acc: 0.9844 - ETA: 5s - loss: 0.6089 - acc: 0.7746
	Epoch 19/20
	25000/25000 [==============================] - 13s - loss: 0.6152 - acc: 0.7732 - val_loss: 0.1066 - val_acc: 0.9788 - ETA: 5s - loss: 0.6230 - acc: 0.7715 - ETA: 5s - loss: 0.6244 - acc: 0.7714 - ETA: 4s - loss: 0.6261 - acc: 0.7696
	Epoch 20/20
	25000/25000 [==============================] - 12s - loss: 0.6144 - acc: 0.7771 - val_loss: 0.0745 - val_acc: 0.9836 - ETA: 8s - loss: 0.6185 - acc: 0.7739
	Out[14]:
	<keras.callbacks.History at 0x7fd888fb2910>
```


### Save model


```python
name = 'mnist_CNN_'+str(epochs_for_cnn)+'e_'+str(training_samples_for_cnn)+'i.h5'
model1.save(name)
```

### Results of approach 2

> 97.06%

Still good!

```python
params1 = model1.metrics_names
results1 = (model1.evaluate(cnn_x_test,cnn_y_test,verbose=0))

print params1[0]," : ", results1[0]
print params1[1]," : ", results1[1]
```

    loss  :  0.119442222269
	acc  :  0.9706
```

#### Analysis of results

Using a CAE to initialize weights of a CNN provided additional accuracy of 0.2% over a CNN only model.
But in the above case, we had 25000 labelled and 25000 unlabelled samples. Consider the case, where we have only 10000 labelled sample (or even less) and similar number of unlabelled samples. In such a case we should see a benefit in accuracy greater than 0.20%.
